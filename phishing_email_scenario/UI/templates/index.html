<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cyber Range Control Panel</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4 text-primary">Cyber Range Demo</h1>

        <div class="mb-3">
            <button class="btn btn-success me-2" onclick="streamVagrantOutput('up')">Start Environment</button>
            <button class="btn btn-danger me-2" onclick="streamVagrantOutput('halt')">Stop Environment</button>
            <button class="btn btn-info" onclick="window.location.href='/guide'">View Guide</button>
        </div>

        <div class="row">
            <div class="col-md-4 mb-4">
                <h2 class="h5">Vagrant Status</h2>
                <pre id="vagrant-status" class="bg-white border rounded p-2" style="height: 100px; overflow-y: scroll;"></pre>
            </div>
            <div class="col-md-4 mb-4">
                <h2 class="h5">Live Logs</h2>
                <pre id="logs" class="bg-white border rounded p-2" style="height: 300px; overflow-y: scroll;"></pre>
            </div>
            <div class="col-md-4 mb-4">
                <h2 class="h5">Live Vagrant Logs</h2>
                <pre id="log-output" class="bg-white border rounded p-2" style="height: 300px; overflow-y: scroll;"></pre>
            </div>
            <div class="col-md-4 mb-4">
                <h2 class="h5">Linux Terminal Output</h2>
                <pre id="terminal-output" class="bg-dark text-success border rounded p-2" style="height: 300px; overflow-y: scroll; font-family: 'Fira Mono', 'Consolas', monospace;"></pre>
            </div>
        </div>
    </div>

    <script>
        const logBox = document.getElementById("logs");
        const logOutput = document.getElementById("log-output");
        const vagrantStatus = document.getElementById("vagrant-status");

        function fetchVagrantStatus() {
            fetch("/vagrant-status")
                .then(response => response.text())
                .then(data => {
                    vagrantStatus.textContent = data;
                })
                .catch(error => {
                    vagrantStatus.textContent = "Error fetching status.";
                    console.error("Error fetching Vagrant status:", error);
                });
        }

        function streamVagrantOutput(command) {
            logOutput.textContent = ""; // Clear previous output
            const eventSource = new EventSource(`/stream-vagrant-output?command=${command}`);
            eventSource.onmessage = function(event) {
                logOutput.textContent += event.data + "\n";
                logOutput.scrollTop = logOutput.scrollHeight;
            };
            eventSource.onerror = function(event) {
                logOutput.textContent += "[Error: Log stream disconnected]\n";
                eventSource.close();
                fetchVagrantStatus(); // Update status after command finishes
            };
        }

        // Connect to log stream
        const eventSource = new EventSource("/logs");
        eventSource.onmessage = function(event) {
            logBox.textContent += event.data + "\n";
            logBox.scrollTop = logBox.scrollHeight;
        };
        eventSource.onerror = function(event) {
            logBox.textContent += "[Error: Log stream disconnected]\n";
            eventSource.close();
        };

        // Initial status check and periodic updates
        fetchVagrantStatus();
        setInterval(fetchVagrantStatus, 10000); // Update every 10 seconds
    </script>
</body>
</html>
