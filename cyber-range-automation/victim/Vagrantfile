Vagrant.configure("2") do |config|
  config.vm.define "victim" do |victim|
    victim.vm.box = "gusztavvargadr/windows-10"
    victim.vm.hostname = "victim"

    # Use WinRM to communicate with Windows
    victim.vm.communicator = "winrm"
    victim.winrm.username = "vagrant"
    victim.winrm.password = "vagrant"

    # Private IP to access via Guacamole (or attacker VM)
    victim.vm.network "private_network", ip: "192.168.56.12"

    # Forward WinRM (for provisioning and remote commands)
    victim.vm.network "forwarded_port", guest: 5985, host: 55985, auto_correct: true

    # Forward RDP port to host
    victim.vm.network "forwarded_port", guest: 3389, host: 3389, auto_correct: true

    victim.vm.provider "virtualbox" do |vb|
      vb.gui = true  # Set to true to view the Windows UI (recommended for debugging)
      vb.memory = 4096
      vb.cpus = 2
    end

    # Enable RDP and set password via PowerShell
    victim.vm.provision "shell", privileged: false, inline: <<-POWERSHELL
      net user vagrant vagrant
      Set-ItemProperty -Path 'HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server' -Name "fDenyTSConnections" -Value 0
      Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
    POWERSHELL
  end
end
